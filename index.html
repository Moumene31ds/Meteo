<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EARTH PRO | ŸÖÿ≠ÿ∑ÿ© ÿßŸÑÿ±ÿµÿØ ÿßŸÑÿ¨ŸàŸä ÿßŸÑÿπÿßŸÑŸÖŸäÿ©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;800&family=Exo+2:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --blue: #4facfe;
            --dark: #0a0a0a;
            --glass: rgba(15, 20, 30, 0.75);
            --border: rgba(255, 255, 255, 0.1);
            --text-glow: 0 0 10px rgba(79, 172, 254, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { background: #000; overflow: hidden; height: 100vh; color: white; user-select: none; }

        /* Canvas */
        #canvas-container { position: absolute; inset: 0; z-index: 1; }

        /* UI Layout */
        #ui-layer {
            position: absolute; inset: 0; z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; padding: 20px;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.4) 100%);
        }

        /* HEADER */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            pointer-events: auto; width: 100%; z-index: 20;
        }

        .brand {
            font-family: 'Exo 2'; font-size: 1.6rem; letter-spacing: 2px; font-weight: 800;
            background: linear-gradient(90deg, #fff, var(--blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .search-dock {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 50px;
            padding: 5px 10px; display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
        }
        .search-dock:focus-within { border-color: var(--blue); box-shadow: 0 0 20px rgba(79, 172, 254, 0.3); }

        input { background: transparent; border: none; color: white; width: 140px; font-size: 0.95rem; text-align: right; }
        .btn-icon { background: none; border: none; color: white; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: var(--blue); }

        /* GEOLOCATION BTN */
        .geo-btn {
            background: linear-gradient(135deg, var(--blue), #00f2fe);
            color: #000; font-weight: bold; border: none; padding: 8px 15px;
            border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 5px;
            font-size: 0.85rem; box-shadow: 0 0 15px rgba(79, 172, 254, 0.4);
            transition: 0.3s;
        }
        .geo-btn:hover { transform: scale(1.05); }

        /* DASHBOARD */
        .dashboard {
            margin-top: auto; display: grid; gap: 20px;
            grid-template-columns: 1fr 400px;
            width: 100%; pointer-events: none; align-items: end;
        }

        .panel {
            background: var(--glass); backdrop-filter: blur(30px);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 25px; pointer-events: auto;
            transform: translateY(100px); opacity: 0;
            transition: all 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .panel.active { transform: translateY(0); opacity: 1; }

        /* Weather Info */
        .weather-info { text-align: right; position: relative; overflow: hidden; }
        .weather-info::before {
            content: ''; position: absolute; top:0; right:0; width: 4px; height: 100%;
            background: var(--blue); box-shadow: 0 0 10px var(--blue);
        }

        .location-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .city-name { font-size: 1.5rem; font-weight: 700; }
        .date-time { font-size: 0.8rem; color: #aaa; font-family: 'Exo 2'; }

        .main-temp-wrapper { display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin: 10px 0; }
        .weather-icon-lg { font-size: 3rem; }
        .temp-huge { font-family: 'Exo 2'; font-size: 4.5rem; line-height: 1; font-weight: 700; }

        .desc-text { color: var(--blue); font-size: 1.1rem; margin-bottom: 20px; text-transform: capitalize; }

        /* Grid Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px; text-align: center; }
        .stat-label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 3px; }
        .stat-val { font-size: 0.95rem; font-weight: bold; font-family: 'Exo 2'; }

        /* Extra Details Row */
        .extra-row { display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; }
        .extra-item { flex: 1; background: rgba(0,255,100,0.05); padding: 8px; border-radius: 8px; font-size: 0.8rem; text-align: center; border: 1px solid rgba(0,255,100,0.1); }
        .extra-item.bad { background: rgba(255,50,50,0.05); border-color: rgba(255,50,50,0.1); }

        /* Chart */
        .chart-panel { height: 180px; display: flex; flex-direction: column; justify-content: center; }

        /* Loader */
        .loader { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; transition: opacity 1s; }
        .loader-ring { width: 60px; height: 60px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--blue); border-radius: 50%; animation: spin 1s infinite linear; }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .chart-panel { display: none; }
            .temp-huge { font-size: 3.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .search-dock { width: 100%; }
            input { width: 100%; }
            .geo-btn span { display: none; } /* Hide text on small screens, keep icon */
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@tweenjs/tween.js": "https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>
</head>
<body>

    <div class="loader" id="loader">
        <div class="loader-ring"></div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <div class="search-dock">
                <button class="btn-icon" onclick="searchCity()">üîç</button>
                <input type="text" id="cityInput" placeholder="ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿØŸäŸÜÿ©..." onkeypress="if(event.key==='Enter') searchCity()">
                <button class="geo-btn" onclick="locateUser()">
                    üìç <span>ŸÖŸàŸÇÿπŸä</span>
                </button>
            </div>
            <div class="brand">EARTH <span style="font-weight:300">PRO</span></div>
        </header>

        <div class="dashboard">
            <div class="panel chart-panel" id="chartPanel">
                <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">ÿ™ŸàŸÇÿπÿßÿ™ ÿßŸÑŸÄ 24 ÿ≥ÿßÿπÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©</div>
                <canvas id="weatherChart"></canvas>
            </div>

            <div class="panel weather-info" id="weatherPanel">
                <div class="location-header">
                    <div class="date-time" id="localTime">--:--</div>
                    <div class="city-name" id="uiCity">--</div>
                </div>

                <div class="main-temp-wrapper">
                    <div class="weather-icon-lg" id="wIcon">‚òÄÔ∏è</div>
                    <div class="temp-huge" id="uiTemp">00¬∞</div>
                </div>
                <div class="desc-text" id="uiDesc">--</div>

                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-label">ÿßŸÑÿ±Ÿäÿßÿ≠</span><span class="stat-val" id="uiWind">--</span></div>
                    <div class="stat-box"><span class="stat-label">ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ©</span><span class="stat-val" id="uiHum">--</span></div>
                    <div class="stat-box"><span class="stat-label">ÿßŸÑÿ∂ÿ∫ÿ∑</span><span class="stat-val" id="uiPress">--</span></div>
                    <div class="stat-box"><span class="stat-label">ÿßŸÑÿ±ÿ§Ÿäÿ©</span><span class="stat-val" id="uiVis">--</span></div>
                </div>

                <div class="extra-row">
                    <div class="extra-item" id="aqiBox">ÿ¨ŸàÿØÿ© ÿßŸÑŸáŸàÿßÿ°: <b id="uiAQI">--</b></div>
                    <div class="extra-item">UV Index: <b id="uiUV">--</b></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import TWEEN from '@tweenjs/tween.js';

        // --- 1. SETUP SCENE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 18;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enablePan = false;
        controls.minDistance = 7;
        controls.maxDistance = 50;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- 2. REALISTIC EARTH ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const textureLoader = new THREE.TextureLoader();

        // A. Earth Sphere (Diffuse + Specular + Normal)
        // Using reliable high-res textures from GitHub repository
        const earthGeo = new THREE.SphereGeometry(5, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
            specularMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg'),
            normalMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg'),
            shininess: 15
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // B. Cloud Layer
        const cloudGeo = new THREE.SphereGeometry(5.08, 64, 64);
        const cloudMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide
        });
        const clouds = new THREE.Mesh(cloudGeo, cloudMat);
        earthGroup.add(clouds);

        // C. Atmosphere Halo (Shader)
        const atmosGeo = new THREE.SphereGeometry(5.4, 64, 64);
        const atmosMat = new THREE.ShaderMaterial({
            uniforms: { 
                c: { value: 0.6 }, p: { value: 4.5 }, glowColor: { value: new THREE.Color(0x4facfe) }, viewVector: { value: camera.position } 
            },
            vertexShader: `uniform vec3 viewVector; varying float intensity; void main() { vec3 vNormal = normalize(normalMatrix * normal); vec3 vNormel = normalize(normalMatrix * viewVector); intensity = pow(c - dot(vNormal, vNormel), p); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform vec3 glowColor; varying float intensity; void main() { vec3 glow = glowColor * intensity; gl_FragColor = vec4(glow, 1.0); }`,
            side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true
        });
        const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
        scene.add(atmosphere);

        // D. Starfield
        const starGeo = new THREE.BufferGeometry();
        const starCount = 3000;
        const posArray = new Float32Array(starCount * 3);
        for(let i=0; i<starCount*3; i++) posArray[i] = (Math.random()-0.5) * 600;
        starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const starMat = new THREE.PointsMaterial({size:0.2, color:0xffffff, transparent:true, opacity:0.8});
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        // E. Lighting
        const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
        sunLight.position.set(20, 10, 20);
        scene.add(sunLight);
        scene.add(new THREE.AmbientLight(0x404040, 0.5)); // Soft fill light

        // --- 3. GEOLOCATION & WEATHER LOGIC ---
        
        let pin = null;
        let chartInstance = null;

        // Auto Locate
        window.locateUser = () => {
            const btn = document.querySelector('.geo-btn');
            btn.innerHTML = '‚åõ ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ÿØŸäÿØ...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        searchByCoords(latitude, longitude);
                        btn.innerHTML = 'üìç ŸÖŸàŸÇÿπŸä';
                    },
                    (error) => {
                        alert("ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ. Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÄ GPS.");
                        btn.innerHTML = 'üìç ŸÖŸàŸÇÿπŸä';
                    }
                );
            } else {
                alert("ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ");
            }
        };

        window.searchCity = async () => {
            const city = document.getElementById('cityInput').value;
            if(!city) return;
            
            try {
                const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=ar&format=json`).then(r=>r.json());
                if(!geo.results) throw new Error("Not Found");
                searchByCoords(geo.results[0].latitude, geo.results[0].longitude);
            } catch(e) { alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿØŸäŸÜÿ©"); }
        };

        async function searchByCoords(lat, lon) {
            // Animation
            flyTo(lat, lon);
            addPin(lat, lon);

            // Fetch Data (Comprehensive)
            // Including: Air Quality (AQI), UV, Pressure, Sunrise/Sunset
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,surface_pressure,visibility,is_day&hourly=temperature_2m&daily=uv_index_max,sunrise,sunset&timezone=auto&air_quality=european_aqi`;
            
            const res = await fetch(url).then(r=>r.json());
            updateUI(res, lat, lon);
        }

        function updateUI(data, lat, lon) {
            const cur = data.current;
            const daily = data.daily;
            const hourly = data.hourly;
            
            // Show Panels
            document.querySelectorAll('.panel').forEach(p => p.classList.add('active'));

            // Basic Info
            const timezone = data.timezone;
            const timeString = new Date().toLocaleTimeString('en-US', { timeZone: timezone, hour: '2-digit', minute:'2-digit' });
            
            // Reverse Geocoding for City Name (Simple display)
            // Note: Open-Meteo gives timezone city, for better accuracy we usually need reverse geo API. 
            // Here we format the timezone string for display.
            const cityDisplay = data.timezone.split('/')[1].replace(/_/g, ' ');

            document.getElementById('uiCity').innerText = cityDisplay;
            document.getElementById('localTime').innerText = `ÿßŸÑÿ™ŸàŸÇŸäÿ™ ÿßŸÑŸÖÿ≠ŸÑŸä: ${timeString}`;
            document.getElementById('uiTemp').innerText = Math.round(cur.temperature_2m) + "¬∞";
            document.getElementById('uiDesc').innerText = getWeatherText(cur.weather_code);
            document.getElementById('wIcon').innerText = getWeatherIcon(cur.weather_code, cur.is_day);

            // Stats
            document.getElementById('uiWind').innerText = cur.wind_speed_10m + " km/h";
            document.getElementById('uiHum').innerText = cur.relative_humidity_2m + "%";
            document.getElementById('uiPress').innerText = cur.surface_pressure + " hPa";
            document.getElementById('uiVis').innerText = (cur.visibility / 1000).toFixed(1) + " km";
            
            // Extra
            document.getElementById('uiUV').innerText = daily.uv_index_max[0];
            
            // AQI (If available in API call)
            if(data.current.european_aqi) {
                const aqi = data.current.european_aqi;
                const aqiEl = document.getElementById('uiAQI');
                aqiEl.innerText = aqi;
                const box = document.getElementById('aqiBox');
                if(aqi > 50) box.classList.add('bad'); else box.classList.remove('bad');
            } else {
                document.getElementById('uiAQI').innerText = "N/A";
            }

            // Chart
            updateChart(hourly);

            // Day/Night Lighting
            if(cur.is_day === 1) {
                sunLight.intensity = 2.5;
                atmosphere.material.uniforms.glowColor.value.setHex(0x4facfe);
            } else {
                sunLight.intensity = 0.2;
                atmosphere.material.uniforms.glowColor.value.setHex(0x1a237e); // Night glow
            }
        }

        // --- 4. HELPERS ---

        function flyTo(lat, lon) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            
            // Rotate Earth
            const targetX = lat * (Math.PI / 180);
            const targetY = -1 * (lon * (Math.PI / 180)) - (Math.PI / 2);

            new TWEEN.Tween(earthGroup.rotation)
                .to({ x: targetX, y: targetY }, 1500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();
        }

        function addPin(lat, lon) {
            if(pin) earthGroup.remove(pin);
            
            // Calculate Position on Sphere
            const r = 5.05;
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const y = r * Math.cos(phi);
            const z = r * Math.sin(phi) * Math.sin(theta);

            // Pin Mesh
            const geom = new THREE.ConeGeometry(0.1, 0.4, 8);
            geom.rotateX(Math.PI/2);
            const mat = new THREE.MeshBasicMaterial({color: 0xff0055});
            pin = new THREE.Mesh(geom, mat);
            pin.position.set(x, y, z);
            pin.lookAt(0,0,0);
            earthGroup.add(pin);
        }

        function updateChart(hourly) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const gradient = ctx.createLinearGradient(0,0,0,150);
            gradient.addColorStop(0, 'rgba(79, 172, 254, 0.6)');
            gradient.addColorStop(1, 'rgba(79, 172, 254, 0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourly.time.slice(0, 24).map(t => t.slice(11, 16)),
                    datasets: [{
                        data: hourly.temperature_2m.slice(0, 24),
                        borderColor: '#4facfe',
                        backgroundColor: gradient,
                        fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function getWeatherText(code) {
            const map = { 0:"ÿµÿßŸÅŸç", 1:"ÿ∫ÿßÿ¶ŸÖ ÿ¨ÿ≤ÿ¶ŸäÿßŸã", 2:"ÿ∫ÿßÿ¶ŸÖ", 3:"ŸÖŸÑÿ®ÿØ", 45:"ÿ∂ÿ®ÿßÿ®", 51:"ÿ±ÿ∞ÿßÿ∞", 61:"ŸÖÿ∑ÿ±", 71:"ÿ´ŸÑŸàÿ¨", 95:"ÿπÿßÿµŸÅÿ©" };
            return map[code] || "ŸÖÿπÿ™ÿØŸÑ";
        }

        function getWeatherIcon(code, isDay) {
            if(code === 0) return isDay ? "‚òÄÔ∏è" : "üåô";
            if(code <= 3) return "‚òÅÔ∏è";
            if(code <= 50) return "üå´Ô∏è";
            if(code <= 67) return "üåßÔ∏è";
            if(code <= 77) return "‚ùÑÔ∏è";
            return "‚õàÔ∏è";
        }

        // Loop
        function animate(t) {
            requestAnimationFrame(animate);
            TWEEN.update(t);
            controls.update();
            
            // Rotations
            clouds.rotation.y += 0.00025; // Clouds move slightly faster
            if(!pin) earthGroup.rotation.y += 0.0001; // Idle spin
            
            // Atmosphere Shader Update
            atmosphere.material.uniforms.viewVector.value = new THREE.Vector3().subVectors(camera.position, atmosphere.position);
            
            renderer.render(scene, camera);
        }
        animate();

        // Load remove
        window.onload = () => {
            setTimeout(() => document.getElementById('loader').style.opacity = 0, 1000);
            setTimeout(() => document.getElementById('loader').remove(), 2000);
        };

    </script>
</body>
</html>
