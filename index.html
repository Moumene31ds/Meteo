<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALGERIA WEATHER | 3D Cast</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡©ğŸ‡¿</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <style>
        :root {
            --dz-green: #006233;
            --dz-red: #D21034;
            --neon-white: #f0f0f0;
            --glass-bg: rgba(8, 24, 15, 0.85); /* Dark Green Tint */
            --border: rgba(255, 255, 255, 0.15);
            --accent: #00ff88;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background: #020503; overflow: hidden; height: 100vh; color: white; user-select: none; transition: background 1s;
        }

        /* Cinematic Overlays */
        #fx-layer { position: absolute; inset: 0; pointer-events: none; z-index: 5; opacity: 0.6; mix-blend-mode: screen; transition: opacity 1s; }
        .rain { background: url('https://i.imgur.com/VuT2g8X.png'); animation: rain 0.4s linear infinite; }
        .snow { background: url('https://i.imgur.com/8R0TjqV.png'); animation: snow 8s linear infinite; }
        @keyframes rain { 0% { background-position: 0 0; } 100% { background-position: 10% 100%; } }
        @keyframes snow { 0% { background-position: 0 0; } 100% { background-position: 100% 100%; } }

        /* Canvas */
        #canvas-container { position: absolute; inset: 0; z-index: 1; cursor: grab; background: radial-gradient(circle at center, #0a1a10 0%, #000000 100%); }
        #canvas-container:active { cursor: grabbing; }

        /* UI Layer */
        #ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; padding: 20px; transition: all 0.5s; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; width: 100%; z-index: 20; transition: transform 0.5s; }
        .brand { 
            font-family: 'Rajdhani', sans-serif; font-size: 1.5rem; font-weight: 900; letter-spacing: 1px;
            display: flex; flex-direction: column; line-height: 1;
        }
        .brand span:first-child { color: var(--neon-white); }
        .brand span:last-child { color: var(--dz-red); letter-spacing: 4px; font-size: 0.9rem;}

        .search-dock {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); border: 1px solid var(--border);
            border-radius: 50px; padding: 5px 8px; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .search-dock:focus-within { border-color: var(--dz-green); box-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }

        input { background: transparent; border: none; color: white; width: 180px; font-size: 1rem; text-align: right; padding: 5px; font-weight: 500; }
        input::placeholder { color: rgba(255,255,255,0.4); font-size: 0.9rem;}
        
        .btn-icon { 
            background: rgba(255,255,255,0.05); border: 1px solid transparent; color: white; cursor: pointer; 
            width:40px; height:40px; border-radius: 50%; transition: 0.2s; display:flex; align-items:center; justify-content:center; font-size: 1.1rem; 
        }
        .btn-icon:hover { background: rgba(255,255,255,0.15); color: var(--accent); transform: scale(1.05); }
        .btn-icon.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }
        .recording { color: var(--dz-red); border-color: var(--dz-red); animation: pulse 1.5s infinite; }
        
        /* Cast Specific Styles */
        .cast-connected { 
            color: var(--accent) !important; 
            border-color: var(--accent) !important;
            box-shadow: 0 0 20px var(--accent);
            animation: breathe 3s infinite;
        }
        
        /* Remote Control Panel */
        .cast-remote {
            position: fixed; top: 90px; right: 20px;
            background: rgba(10, 20, 10, 0.9); border: 1px solid var(--accent);
            border-radius: 15px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; z-index: 50; width: 60px; align-items: center;
        }
        .cast-remote.show { transform: translateX(0); }
        .cast-status-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); margin-bottom: 5px;}

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(210, 16, 52, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(210, 16, 52, 0); } 100% { box-shadow: 0 0 0 0 rgba(210, 16, 52, 0); } }
        @keyframes breathe { 0% { box-shadow: 0 0 10px var(--accent); } 50% { box-shadow: 0 0 25px var(--accent); } 100% { box-shadow: 0 0 10px var(--accent); } }

        /* Controls Side Bar */
        .controls { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 12px; pointer-events: auto; transition: transform 0.5s; }

        /* Dashboard */
        .dashboard { margin-top: auto; display: flex; gap: 20px; align-items: flex-end; width: 100%; pointer-events: none; transition: all 0.5s; }
        
        .panel {
            background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; pointer-events: auto;
            transform: translateY(120px); opacity: 0; transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
        .panel.active { transform: translateY(0); opacity: 1; }

        /* Left Col */
        .left-col { width: 340px; display: flex; flex-direction: column; gap: 10px; }
        .chart-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; font-family: 'Rajdhani'; letter-spacing: 1px; }
        .forecast-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; direction: ltr; }
        .day-card { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 10px 5px; text-align: center; min-width: 60px; border: 1px solid rgba(255,255,255,0.02); }
        .day-temp { font-family: 'Rajdhani'; font-weight: 700; margin-top: 5px; color: var(--accent); }

        /* Main Weather Card */
        .weather-main { flex: 1; max-width: 500px; position: relative; overflow: hidden; transition: all 0.8s ease-in-out; }
        .weather-main::before { content: ''; position: absolute; top:0; right:0; width:4px; height:100%; background: linear-gradient(180deg, var(--dz-green), var(--dz-red)); }
        
        .city-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .city-name { font-size: 2.2rem; font-weight: 900; line-height: 1.1; margin-bottom: 5px; transition: font-size 0.5s; color: white; }
        .city-meta { font-family: 'Rajdhani'; color: #888; font-size: 0.8rem; letter-spacing: 1px; display: flex; gap: 10px; flex-direction: row-reverse; }
        
        .weather-flex { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; direction: ltr; }
        .temp-huge { font-family: 'Rajdhani'; font-size: 4.5rem; font-weight: 700; line-height: 0.9; transition: font-size 0.5s; color: white;}
        .desc-text { color: var(--accent); font-size: 1.2rem; margin-top: 5px; text-align: right; }
        .weather-icon { font-size: 4rem; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); transition: transform 0.5s; }

        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; direction: ltr; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 0.7rem; color: #aaa; display: block; margin-bottom: 3px; }
        .stat-val { font-family: 'Rajdhani'; font-weight: 700; font-size: 1rem; }

        /* Loader */
        .loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; transition: opacity 1s; }
        .dz-loader { width: 50px; height: 50px; border: 3px solid transparent; border-top-color: var(--dz-green); border-bottom-color: var(--dz-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 800px) {
            .dashboard { flex-direction: column-reverse; padding-bottom: 80px; }
            .left-col { display: none; }
            .weather-main { width: 100%; max-width: 100%; }
            .search-dock { width: 100%; justify-content: space-between; }
            input { width: 100%; }
            .controls { top: auto; bottom: 20px; right: 50%; transform: translateX(50%); flex-direction: row; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 30px; border: 1px solid var(--border); }
            .cast-remote { top: auto; bottom: 120px; right: 20px; }
            .brand { display: none; } /* Hide brand on mobile to save space */
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@tweenjs/tween.js": "https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>
</head>
<body>

    <div class="loader" id="loader">
        <div style="text-align: center;">
            <div class="dz-loader"></div>
            <div style="margin-top: 20px; font-family: 'Rajdhani'; letter-spacing: 5px; color: #888; font-size: 0.8rem;">ALGERIA LOADING</div>
        </div>
    </div>

    <div class="cast-remote" id="castRemote">
        <div class="cast-status-dot"></div>
        <button class="btn-icon" onclick="stopCast()" title="Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«" style="color: var(--dz-red); border-color: var(--dz-red)">â¹</button>
        <button class="btn-icon" onclick="forceUpdateTV()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„ÙØ§Ø²">ğŸ”„</button>
    </div>

    <div id="fx-layer"></div>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <div class="search-dock">
                <button class="btn-icon" onclick="searchCity()">ğŸ”</button>
                <input type="text" id="cityInput" placeholder="ÙˆÙ„Ø§ÙŠØ© Ø£Ùˆ Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©..." onkeypress="if(event.key==='Enter') searchCity()">
                <button class="btn-icon" id="micBtn" onclick="toggleVoice()">ğŸ™ï¸</button>
            </div>
            <div class="brand">
                <span>ALGERIA</span>
                <span>WEATHER</span>
            </div>
        </header>

        <div class="controls">
            <button class="btn-icon" id="castBtn" onclick="requestCastSession()" title="Ø¨Ø« Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.92-11-11-11zM21 3H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                </svg>
            </button>

            <button class="btn-icon" id="tourBtn" onclick="toggleTour()" title="Ø¬ÙˆÙ„Ø© ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª">ğŸšŒ</button>
            <button class="btn-icon" onclick="toggleHolo()" title="Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©">ğŸŒ</button>
            <button class="btn-icon" onclick="toggleTTS()" id="ttsBtn" title="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ">ğŸ”Š</button>
        </div>

        <div class="dashboard">
            <div class="panel left-col active">
                <div class="chart-header">
                    <span>ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø©</span>
                    <span style="color:var(--accent)">ECMWF AI</span>
                </div>
                <div style="height: 100px; margin: 10px 0;">
                    <canvas id="weatherChart"></canvas>
                </div>
                <div class="forecast-row" id="forecastRow"></div>
            </div>

            <div class="panel weather-main" id="weatherPanel">
                <div class="city-header">
                    <div>
                        <div class="city-name" id="uiCity">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</div>
                        <div class="city-meta">
                            <span id="uiCoords">28.00, 1.60</span>
                            <span id="uiTime" style="color:var(--accent)">--:--</span>
                        </div>
                    </div>
                </div>

                <div class="weather-flex">
                    <div class="weather-icon" id="uiIcon">ğŸ‡©ğŸ‡¿</div>
                    <div style="text-align: right;">
                        <div class="temp-huge" id="uiTemp">--Â°</div>
                        <div class="desc-text" id="uiDesc">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</div>
                    </div>
                </div>

                <div class="details-grid">
                    <div class="stat-box">
                        <span class="stat-label">Ø§Ù„Ø±ÙŠØ§Ø­</span>
                        <span class="stat-val" id="uiWind">--</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</span>
                        <span class="stat-val" id="uiHum">--</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">UV Ù…Ø¤Ø´Ø±</span>
                        <span class="stat-val" id="uiUV" style="color:var(--accent)">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import TWEEN from '@tweenjs/tween.js';

        // --- GLOBAL STATE ---
        let pin = null;
        let chartInstance = null;
        let isFetching = false;
        let isTouring = false;
        let tourTimer = null;
        let ttsEnabled = false;

        // Start focused on Algeria (Center point approx)
        const START_LAT = 28.0339;
        const START_LON = 1.6596;

        let currentWeatherData = {
            city: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
            temp: 0,
            desc: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
            code: 0,
            hum: 0,
            wind: 0
        };

        let earth, clouds, atmosphere, stars, sunLight, sunSprite;
        let realisticMat, holoMat;
        let isHolo = false;

        // --- 1. ENHANCED CAST IMPLEMENTATION FOR ALGERIA ---
        let castSession = null;

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            const context = cast.framework.CastContext.getInstance();
            context.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                function(event) {
                    const btn = document.getElementById('castBtn');
                    const remote = document.getElementById('castRemote');
                    
                    switch (event.sessionState) {
                        case cast.framework.SessionState.SESSION_STARTED:
                        case cast.framework.SessionState.SESSION_RESUMED:
                            castSession = event.session;
                            btn.classList.add('cast-connected');
                            remote.classList.add('show');
                            speakText("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†");
                            syncToTV();
                            break;
                        case cast.framework.SessionState.SESSION_ENDED:
                            castSession = null;
                            btn.classList.remove('cast-connected');
                            remote.classList.remove('show');
                            break;
                    }
                }
            );
        }

        window.requestCastSession = function() {
            if(!window.cast) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Chrome");
            cast.framework.CastContext.getInstance().requestSession()
                .catch(err => console.error('Cast Error:', err));
        };

        window.stopCast = function() {
            if(castSession) {
                castSession.endSession(true);
            }
        };

        window.forceUpdateTV = function() {
            if(castSession) {
                syncToTV();
                const btn = document.querySelector('.cast-remote button:nth-child(3)');
                btn.style.transform = "rotate(360deg)";
                setTimeout(()=> btn.style.transform = "none", 500);
            }
        };

        function syncToTV() {
            if (!castSession) return;

            // Logic to pick a beautiful background image based on Algerian weather context
            // Using Unsplash keywords for better relevance
            const code = currentWeatherData.code;
            let query = "Algeria nature";
            
            if (code <= 1) query = "Sahara desert sunny";
            else if (code <= 3) query = "Clouds over mountains";
            else if (code <= 45) query = "Foggy forest";
            else if (code <= 67) query = "Rain window view";
            else if (code <= 77) query = "Snow mountain Algeria"; // For Chrea/Tikjda
            else if (code >= 95) query = "Lightning storm";

            // Add random seed to avoid caching same image
            const mediaUrl = `https://source.unsplash.com/1920x1080/?${encodeURIComponent(query)}&sig=${Date.now()}`;
            // Fallback since Source.unsplash is deprecated sometimes, using direct collection logic or generic
            // Using specific curated visuals for reliability:
            let bgImage = 'https://images.unsplash.com/photo-1548231086-64673295b9c0?q=80&w=1920'; // Algiers Generic
            
            // Dynamic Mapping
            if(currentWeatherData.desc.includes("Ù…Ø·Ø±")) bgImage = 'https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=1920';
            else if(currentWeatherData.desc.includes("Ø«Ù„ÙˆØ¬")) bgImage = 'https://images.unsplash.com/photo-1483664852095-d6cc6870702d?q=80&w=1920';
            else if(currentWeatherData.desc.includes("Ø´Ù…Ø³") || currentWeatherData.desc.includes("ØµØ§ÙÙŠØ©")) bgImage = 'https://images.unsplash.com/photo-1549309019-a1d77aeae74f?q=80&w=1920'; // Desert vibe
            else bgImage = 'https://images.unsplash.com/photo-1584967918940-a7d51b064268?q=80&w=1920'; // Clouds

            const mediaInfo = new chrome.cast.media.MediaInfo(bgImage, 'image/jpeg');
            
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = currentWeatherData.city; 
            // Send rich data in subtitle
            mediaInfo.metadata.subtitle = `${currentWeatherData.temp}Â°C  |  ${currentWeatherData.desc}  |  ğŸ’¨ ${currentWeatherData.wind} km/h`;

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;

            castSession.loadMedia(request).catch(e => console.log(e));
        }

        // --- 2. THREE JS SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 20; // Slightly further back for better view

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enablePan = false;
        controls.minDistance = 6.5;
        controls.maxDistance = 60;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.8;

        // --- 3. THE EARTH (Algeria Centric Textures) ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);
        const texLoader = new THREE.TextureLoader();
        
        const tDay = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg');
        const tNight = texLoader.load('https://raw.githubusercontent.com/kyleredelinghuys/three-earth/master/src/img/earth_lights_2048.png');
        const tNormal = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg');
        const tSpec = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg');
        const tClouds = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png');

        realisticMat = new THREE.ShaderMaterial({
            uniforms: {
                sunDirection: { value: new THREE.Vector3(1, 0, 0) },
                dayTexture: { value: tDay },
                nightTexture: { value: tNight },
                normalMap: { value: tNormal },
                specularMap: { value: tSpec }
            },
            vertexShader: `
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec3 vSunDir;
                uniform vec3 sunDirection;
                void main() {
                    vUv = uv;
                    vNormal = normalize(normalMatrix * normal);
                    vSunDir = normalize((viewMatrix * vec4(sunDirection, 0.0)).xyz);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D dayTexture;
                uniform sampler2D nightTexture;
                uniform sampler2D normalMap;
                uniform sampler2D specularMap;
                varying vec2 vUv;
                varying vec3 vNormal;
                varying vec3 vSunDir;
                void main() {
                    vec3 dayColor = texture2D(dayTexture, vUv).rgb;
                    vec3 nightColor = texture2D(nightTexture, vUv).rgb;
                    float intensity = max(dot(vNormal, vSunDir), 0.0);
                    float mixVal = smoothstep(-0.2, 0.2, intensity);
                    
                    // Algeria Green tint enhancement
                    vec3 finalColor = mix(nightColor, dayColor * intensity, mixVal);
                    
                    if(intensity > 0.0) {
                        float specularFactor = texture2D(specularMap, vUv).r;
                        vec3 halfVector = normalize(vSunDir + vec3(0,0,1));
                        float NdotH = max(dot(vNormal, halfVector), 0.0);
                        float specular = pow(NdotH, 32.0) * specularFactor * intensity;
                        finalColor += vec3(0.5) * specular;
                    }
                    gl_FragColor = vec4(finalColor, 1.0);
                }
            `
        });

        holoMat = new THREE.MeshBasicMaterial({
            color: 0x00ff88, wireframe: true, transparent: true, opacity: 0.15
        });

        earth = new THREE.Mesh(new THREE.SphereGeometry(5, 64, 64), realisticMat);
        earthGroup.add(earth);

        const cloudMat = new THREE.MeshLambertMaterial({
            map: tClouds, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, side: THREE.DoubleSide
        });
        clouds = new THREE.Mesh(new THREE.SphereGeometry(5.08, 64, 64), cloudMat);
        earthGroup.add(clouds);

        const atmosMat = new THREE.ShaderMaterial({
            uniforms: { c: { value: 0.6 }, p: { value: 4.5 }, glowColor: { value: new THREE.Color(0x006233) }, viewVector: { value: camera.position } },
            vertexShader: `
                uniform vec3 viewVector;
                varying float intensity;
                void main() {
                    vec3 vNormal = normalize(normalMatrix * normal);
                    vec3 vNormel = normalize(normalMatrix * viewVector);
                    intensity = pow(c - dot(vNormal, vNormel), p);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform vec3 glowColor;
                varying float intensity;
                void main() { gl_FragColor = vec4(glowColor, intensity); }
            `,
            side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false
        });
        atmosphere = new THREE.Mesh(new THREE.SphereGeometry(5.4, 64, 64), atmosMat);
        scene.add(atmosphere);

        const starGeo = new THREE.BufferGeometry();
        const starCount = 8000;
        const posArray = new Float32Array(starCount * 3);
        for(let i=0; i<starCount; i++) {
            posArray[i*3] = (Math.random()-0.5) * 1500;
            posArray[i*3+1] = (Math.random()-0.5) * 1500;
            posArray[i*3+2] = (Math.random()-0.5) * 1500;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color:0xffffff, size:0.5, transparent:true, opacity:0.8}));
        scene.add(stars);

        // Position initial rotation to face Algeria roughly
        // Algeria is roughly 28N, 2E. 
        // ThreeJS rotation is tricky, we use a helper function to start there.
        const startPhi = (90 - START_LAT) * (Math.PI / 180);
        const startTheta = (START_LON + 90) * (Math.PI / 180);
        // We set initial rotation inverse to look at it
        earthGroup.rotation.y = -1 * (START_LON * (Math.PI/180)) - (Math.PI/2);
        earthGroup.rotation.x = START_LAT * (Math.PI/180);


        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let isDragging = false, startPos = {x:0,y:0};
        
        renderer.domElement.addEventListener('mousedown', (e)=>{ isDragging=false; startPos={x:e.clientX,y:e.clientY}; if(!isTouring) controls.autoRotate=false; });
        renderer.domElement.addEventListener('mousemove', (e)=>{ if(Math.abs(e.clientX-startPos.x)>5) isDragging=true; });
        renderer.domElement.addEventListener('mouseup', (e)=>{ if(!isDragging) handleClick(e); if(!isTouring && !isFetching) setTimeout(()=>controls.autoRotate=true, 5000); });
        renderer.domElement.addEventListener('touchstart', (e)=>{ isDragging=false; startPos={x:e.touches[0].clientX,y:e.touches[0].clientY}; controls.autoRotate=false; }, {passive:false});

        function handleClick(e) {
            if(isTouring) stopTour();
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(earth);
            if(intersects.length > 0) {
                const point = intersects[0].point;
                const local = point.clone().applyMatrix4(earthGroup.matrixWorld.invert());
                const spherical = new THREE.Spherical().setFromVector3(local);
                const lat = 90 - (spherical.phi * 180 / Math.PI);
                let lon = ((spherical.theta * 180 / Math.PI) - 90);
                if(lon < -180) lon += 360; if(lon > 180) lon -= 360;
                
                // Only allow clicks roughly within Algeria's bounds to keep it relevant
                // Approx bounds: Lat 18 to 38, Lon -9 to 12
                if(lat > 18 && lat < 38 && lon > -9 && lon < 12) {
                    fetchLocationName(lat, lon);
                    searchByCoords(lat, lon, true);
                } else {
                    document.getElementById('uiCity').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚";
                    document.getElementById('uiDesc').innerText = "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±";
                }
            }
        }

        async function fetchLocationName(lat, lon) {
            try {
                // Using BigDataCloud with Arabic language preference
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ar`);
                const data = await res.json();
                // Logic to display Algerian naming hierarchy
                let name = data.locality || data.city || data.principalSubdivision || "ØµØ­Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±";
                
                // Clean up name
                name = name.replace("Algeria", "").replace("Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "").trim();
                if(name === "") name = "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±";
                
                document.getElementById('uiCity').innerText = name;
                document.getElementById('cityInput').value = name;
                return name;
            } catch(e) { 
                return "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯";
            }
        }

        window.searchCity = async () => {
            const q = document.getElementById('cityInput').value;
            if(!q) return;
            if(isTouring) stopTour();
            try {
                // Strict filtering for Algeria (dz)
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ar&format=json`).then(r=>r.json());
                
                if(!res.results) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©");
                
                // Filter specifically for Algeria
                const dzLoc = res.results.find(r => r.country_code === 'DZ') || res.results[0];
                
                if(dzLoc.country_code !== 'DZ') {
                    alert("Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ø¨Ø­Ø« Ù…Ø®ØµØµ Ù„Ù„Ù…Ø¯Ù† Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© ÙÙ‚Ø·.");
                    return;
                }

                document.getElementById('uiCity').innerText = dzLoc.name;
                searchByCoords(dzLoc.latitude, dzLoc.longitude);
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        };

        async function searchByCoords(lat, lon, isClick=false) {
            if(isFetching) return;
            isFetching = true;
            flyTo(lat, lon);
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,visibility,is_day&hourly=temperature_2m&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max&timezone=auto&models=ecmwf_ifs04`;
            try {
                const data = await fetch(url).then(r=>r.json());
                updateUI(data, lat, lon);
            } catch(e) { console.error(e); }
            isFetching = false;
        }

        function updateUI(data, lat, lon) {
            const cur = data.current;
            const daily = data.daily;
            
            const weatherDesc = getWeatherText(cur.weather_code);
            const cityName = document.getElementById('uiCity').innerText;
            const temp = Math.round(cur.temperature_2m);
            
            // Store data for casting
            currentWeatherData = {
                city: cityName,
                temp: temp,
                desc: weatherDesc,
                code: cur.weather_code,
                wind: cur.wind_speed_10m,
                hum: cur.relative_humidity_2m
            };

            document.querySelectorAll('.panel').forEach(p => p.classList.add('active'));
            document.getElementById('uiCoords').innerText = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
            document.getElementById('uiTime').innerText = new Date().toLocaleTimeString('ar-DZ', {timeZone: data.timezone, hour:'2-digit', minute:'2-digit'});
            document.getElementById('uiTemp').innerText = temp + "Â°";
            document.getElementById('uiDesc').innerText = weatherDesc;
            document.getElementById('uiIcon').innerText = getWeatherIcon(cur.weather_code, cur.is_day);
            document.getElementById('uiWind').innerText = cur.wind_speed_10m + " km/h";
            document.getElementById('uiHum').innerText = cur.relative_humidity_2m + "%";
            document.getElementById('uiUV').innerText = daily.uv_index_max[0].toFixed(1);
            
            // 3D Pin
            addSmartPin(lat, lon, cur.temperature_2m);
            
            // Weather Effects
            const fx = document.getElementById('fx-layer');
            fx.className = ''; fx.style.opacity = 0;
            if([51,53,55,61,63,65,80,81,82,95].includes(cur.weather_code)) { fx.className = 'rain'; fx.style.opacity = 0.6; }
            if([71,73,75,85,86].includes(cur.weather_code)) { fx.className = 'snow'; fx.style.opacity = 0.6; }
            
            updateChart(data.hourly);
            updateForecast(daily);
            
            if(ttsEnabled) speakText(`Ø§Ù„Ø·Ù‚Ø³ ÙÙŠ ${cityName}.. ${weatherDesc}.. ÙˆØ¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ${temp}`);

            // Update TV immediately
            syncToTV();
        }

        function addSmartPin(lat, lon, temp) {
            if(pin) earthGroup.remove(pin);
            pin = new THREE.Group();
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 90) * (Math.PI / 180);
            const r = 5.0;
            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const y = r * Math.cos(phi);
            const z = r * Math.sin(phi) * Math.sin(theta);
            pin.position.set(x,y,z);
            pin.lookAt(0,0,0);
            
            let color = 0x00ff88; // Default
            if(temp > 35) color = 0xff2a2a; // Hot
            if(temp < 10) color = 0x00f3ff; // Cold
            
            // Pin Design
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 1.2, 8), new THREE.MeshBasicMaterial({color:color}));
            stem.rotation.x = Math.PI/2; stem.position.z = 0.6;
            
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.15, 16, 16), new THREE.MeshBasicMaterial({color:color}));
            head.position.z = 1.2;
            
            // Pulse Ring
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.1, 0.2, 32), new THREE.MeshBasicMaterial({color:color, side:2, transparent:true}));
            ring.position.z = 0.05;
            
            pin.add(stem); pin.add(head); pin.add(ring);
            earthGroup.add(pin);
            
            new TWEEN.Tween(ring.scale).to({x:5,y:5}, 1500).repeat(Infinity).start();
            new TWEEN.Tween(ring.material).to({opacity:0}, 1500).repeat(Infinity).start();
        }

        // Algeria Tour List
        const tourCities = [
            {n:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©", lat:36.75, lon:3.05},
            {n:"ÙˆÙ‡Ø±Ø§Ù†", lat:35.69, lon:-0.63},
            {n:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", lat:36.36, lon:6.61},
            {n:"Ø¹Ù†Ø§Ø¨Ø©", lat:36.90, lon:7.76},
            {n:"ÙˆØ±Ù‚Ù„Ø©", lat:31.95, lon:5.32},
            {n:"ØªÙ…Ù†Ø±Ø§Ø³Øª", lat:22.78, lon:5.52},
            {n:"Ø¨Ø´Ø§Ø±", lat:31.62, lon:-2.22},
            {n:"Ø¬Ø§Ù†Ù€Øª", lat:24.55, lon:9.48}
        ];
        let tourIdx = 0;

        window.toggleTour = () => {
            isTouring = !isTouring;
            const btn = document.getElementById('tourBtn');
            if(isTouring) {
                btn.classList.add('active');
                runTourStep();
            } else {
                btn.classList.remove('active');
                clearTimeout(tourTimer);
                controls.autoRotate = true;
            }
        };

        function runTourStep() {
            if(!isTouring) return;
            const city = tourCities[tourIdx];
            document.getElementById('uiCity').innerText = city.n;
            searchByCoords(city.lat, city.lon);
            tourIdx = (tourIdx + 1) % tourCities.length;
            tourTimer = setTimeout(runTourStep, 10000); // 10 seconds per city
        }

        window.toggleTTS = () => {
            ttsEnabled = !ttsEnabled;
            document.getElementById('ttsBtn').classList.toggle('active');
            if(ttsEnabled) speakText("Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØµÙˆØªÙŠ Ù…ÙØ¹Ù„");
        };

        function speakText(text) {
            if(!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-DZ'; // Try Algerian accent if available, else Arabic
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        window.toggleHolo = () => {
            isHolo = !isHolo;
            if(isHolo) {
                earth.material = holoMat;
                clouds.visible = false;
            } else {
                earth.material = realisticMat;
                clouds.visible = true;
            }
        };

        function flyTo(lat, lon) {
            const tx = lat * (Math.PI/180);
            const ty = -1 * (lon * (Math.PI/180)) - (Math.PI/2);
            new TWEEN.Tween(earthGroup.rotation).to({x:tx, y:ty}, 2000).easing(TWEEN.Easing.Cubic.InOut).start();
        }

        function updateChart(hourly) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            // Green gradient for Algeria theme
            const gradient = ctx.createLinearGradient(0,0,0,100);
            gradient.addColorStop(0, 'rgba(0, 255, 136, 0.5)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourly.time.slice(0, 12).map(t => t.slice(11, 16)),
                    datasets: [{
                        data: hourly.temperature_2m.slice(0, 12),
                        borderColor: '#00ff88', backgroundColor: gradient, fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: false }, 
                    scales: { 
                        x: {display:false}, 
                        y: {display:false} 
                    }
                }
            });
        }

        function updateForecast(daily) {
            const c = document.getElementById('forecastRow'); c.innerHTML='';
            for(let i=0; i<5; i++){
                const d = new Date(daily.time[i]);
                const name = d.toLocaleDateString('ar-DZ', {weekday:'short'});
                const icon = getWeatherIcon(daily.weather_code[i], 1);
                const temp = Math.round(daily.temperature_2m_max[i]);
                c.innerHTML += `<div class="day-card"><div style="font-size:0.7rem; color:#aaa">${name}</div><div style="font-size:1.4rem; margin:5px 0">${icon}</div><div class="day-temp">${temp}Â°</div></div>`;
            }
        }

        function getWeatherText(c) {
            const m = {
                0:"Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ©", 1:"ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠ", 2:"ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠ", 3:"ØºØ§Ø¦Ù… ÙƒÙ„ÙŠ", 
                45:"Ø¶Ø¨Ø§Ø¨", 48:"Ø¶Ø¨Ø§Ø¨ Ø¬Ù„ÙŠØ¯ÙŠ",
                51:"Ø±Ø°Ø§Ø° Ø®ÙÙŠÙ", 53:"Ø±Ø°Ø§Ø° Ù…ØªÙˆØ³Ø·", 55:"Ø±Ø°Ø§Ø° ÙƒØ«ÙŠÙ",
                61:"Ù…Ø·Ø± Ø®ÙÙŠÙ", 63:"Ù…Ø·Ø± Ù…ØªÙˆØ³Ø·", 65:"Ù…Ø·Ø± ØºØ²ÙŠØ±",
                71:"Ø«Ù„ÙˆØ¬ Ø®ÙÙŠÙØ©", 73:"Ø«Ù„ÙˆØ¬ Ù…ØªÙˆØ³Ø·Ø©", 75:"Ø«Ù„ÙˆØ¬ ÙƒØ«ÙŠÙØ©",
                80:"Ø²Ø®Ø§Øª Ù…Ø·Ø±", 81:"Ø²Ø®Ø§Øª Ù…Ø·Ø± Ù‚ÙˆÙŠØ©", 82:"Ø¹Ø§ØµÙØ© Ù…Ø·Ø±ÙŠØ©",
                95:"Ø¹Ø§ØµÙØ© Ø±Ø¹Ø¯ÙŠØ©", 96:"Ø±Ø¹Ø¯ ÙˆØ¨Ø±Ø¯", 99:"Ø¹Ø§ØµÙØ© Ø¨Ø±Ø¯ÙŠØ© Ø´Ø¯ÙŠØ¯Ø©"
            };
            return m[c] || "Ø·Ù‚Ø³ Ù…ØªÙ‚Ù„Ø¨";
        }
        function getWeatherIcon(c,d) {
            if(c===0) return d?"â˜€ï¸":"ğŸŒ™"; 
            if(c<=3) return d?"ğŸŒ¤ï¸":"â˜ï¸"; 
            if(c<=48) return "ğŸŒ«ï¸";
            if(c<=67) return "ğŸŒ§ï¸"; 
            if(c<=77) return "â„ï¸"; 
            if(c>=95) return "âš¡";
            return "ğŸŒ¥ï¸";
        }

        function animate(t) {
            requestAnimationFrame(animate);
            TWEEN.update(t);
            controls.update();
            clouds.rotation.y += 0.0004;
            stars.rotation.y -= 0.0001;
            atmosphere.material.uniforms.viewVector.value = new THREE.Vector3().subVectors(camera.position, atmosphere.position);
            renderer.render(scene, camera);
        }
        animate();

        // Start at Algeria (No Geolocation needed for this version, we want strict start)
        window.onload = () => { 
            setTimeout(()=>document.getElementById('loader').style.opacity=0, 1500); 
            setTimeout(()=>document.getElementById('loader').remove(), 2500); 
            // Default load Algiers
            searchByCoords(36.75, 3.05);
        };
        
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        // Voice
        window.toggleVoice = () => {
             const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
             if(!SR) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª");
             const r = new SR(); r.lang='ar-DZ'; r.start();
             document.getElementById('micBtn').classList.add('recording');
             r.onresult = e => { 
                 document.getElementById('cityInput').value = e.results[0][0].transcript; 
                 searchCity(); 
                 document.getElementById('micBtn').classList.remove('recording'); 
            };
            r.onend = () => document.getElementById('micBtn').classList.remove('recording');
        };

    </script>
</body>
</html>
